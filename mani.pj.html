<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Marks Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light background */
            color: #334155; /* Dark gray text */
        }
        /* Custom scrollbar for tables if needed */
        .overflow-x-auto::-webkit-scrollbar {
            height: 8px;
        }
        .overflow-x-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-100">
    <div class="flex flex-col md:flex-row">
        <nav class="bg-gray-800 text-white w-full md:w-64 space-y-4 py-6 px-4 md:h-screen">
            <h2 class="text-2xl font-bold mb-6 text-center text-indigo-300">SMS</h2>
            <ul class="space-y-2">
                <li>
                    <button id="nav-students" class="flex items-center w-full px-4 py-2 rounded-lg transition-colors duration-200 hover:bg-gray-700">
                        <i data-lucide="user" class="mr-3 w-5 h-5"></i> Students
                    </button>
                </li>
                <li>
                    <button id="nav-marks" class="flex items-center w-full px-4 py-2 rounded-lg transition-colors duration-200 hover:bg-gray-700">
                        <i data-lucide="book" class="mr-3 w-5 h-5"></i> Marks
                    </button>
                </li>
                <li>
                    <button id="nav-attendance" class="flex items-center w-full px-4 py-2 rounded-lg transition-colors duration-200 hover:bg-gray-700">
                        <i data-lucide="clipboard-check" class="mr-3 w-5 h-5"></i> Attendance
                    </button>
                </li>
                <li>
                    <button id="nav-feedback" class="flex items-center w-full px-4 py-2 rounded-lg transition-colors duration-200 hover:bg-gray-700">
                        <i data-lucide="message-square" class="mr-3 w-5 h-5"></i> Feedback
                    </button>
                </li>
                <li>
                    <button id="nav-graphs" class="flex items-center w-full px-4 py-2 rounded-lg transition-colors duration-200 hover:bg-gray-700">
                        <i data-lucide="bar-chart-2" class="mr-3 w-5 h-5"></i> Graphs
                    </button>
                </li>
            </ul>
        </nav>

        <main class="flex-1 p-6 md:p-8">
            <header class="mb-8 bg-white p-6 rounded-xl shadow-lg">
                <h1 class="text-3xl font-extrabold text-indigo-700">Student Management System</h1>
                <p id="selected-student-info" class="mt-2 text-lg text-gray-600 hidden">
                    Currently managing data for: <span class="font-semibold text-indigo-800" id="selected-student-name"></span>
                    <button id="clear-student-selection" class="ml-4 text-sm text-red-500 hover:text-red-700">
                        (Clear Selection)
                    </button>
                </p>
                <p id="no-student-selected-warning" class="mt-2 text-md text-red-500 hidden">
                    Please select a student from the 'Students' tab to view/manage their data.
                </p>
            </header>

            <section id="tab-students" class="tab-content bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Students List</h2>
                <button id="add-student-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center mb-6 transition duration-200">
                    <i data-lucide="plus" class="mr-2 w-5 h-5"></i> Add New Student
                </button>
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="tab-marks" class="tab-content bg-white p-6 rounded-xl shadow-lg hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Marks Management</h2>
                <button id="add-mark-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center mb-6 transition duration-200">
                    <i data-lucide="plus" class="mr-2 w-5 h-5"></i> Add Mark
                </button>
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="marks-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="tab-attendance" class="tab-content bg-white p-6 rounded-xl shadow-lg hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Attendance Management</h2>
                <button id="add-attendance-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center mb-6 transition duration-200">
                    <i data-lucide="plus" class="mr-2 w-5 h-5"></i> Mark Attendance
                </button>
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="tab-feedback" class="tab-content bg-white p-6 rounded-xl shadow-lg hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Feedback Management</h2>
                <button id="add-feedback-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center mb-6 transition duration-200">
                    <i data-lucide="plus" class="mr-2 w-5 h-5"></i> Give Feedback
                </button>
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teacher</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Feedback</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="feedback-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="tab-graphs" class="tab-content bg-white p-6 rounded-xl shadow-lg hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Student Performance Graphs</h2>
                <div id="graphs-content">
                    <div class="mb-8">
                        <label for="subjectSelect" class="block text-gray-700 text-sm font-bold mb-2">
                            Select Subject for Performance Trend:
                        </label>
                        <select
                            id="subjectSelect"
                            class="shadow appearance-none border rounded-lg w-full md:w-1/2 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-indigo-500"
                        >
                            </select>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                            <h3 class="text-xl font-semibold mb-4 text-gray-700" id="performance-chart-title">Student Performance (Weekly Average)</h3>
                            <div class="relative h-72">
                                <canvas id="performanceChart"></canvas>
                            </div>
                            <p id="performance-chart-no-data" class="text-center text-gray-500 hidden">No mark data available for this subject.</p>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                            <h3 class="text-xl font-semibold mb-4 text-gray-700" id="attendance-chart-title">Attendance Summary</h3>
                            <div class="relative h-72">
                                <canvas id="attendanceChart"></canvas>
                            </div>
                            <p id="attendance-chart-no-data" class="text-center text-gray-500 hidden">No attendance data available for this student.</p>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg shadow-inner lg:col-span-2">
                            <h3 class="text-xl font-semibold mb-4 text-gray-700" id="marks-distribution-chart-title">Average Marks by Subject</h3>
                            <div class="relative h-72">
                                <canvas id="marksDistributionChart"></canvas>
                            </div>
                            <p id="marks-distribution-chart-no-data" class="text-center text-gray-500 hidden">No mark data available for this student across subjects.</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="action-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-4">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="modal-title" class="text-xl font-semibold text-gray-800"></h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x-circle" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="modal-body" class="space-y-4">
                </div>
            <div class="flex justify-end pt-4 border-t mt-4">
                <button id="modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2 transition duration-200">
                    Cancel
                </button>
                <button id="modal-save-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center transition duration-200">
                    <i data-lucide="save" class="mr-2 w-5 h-5"></i> Save
                </button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Confirm Action</h3>
                <button id="close-confirm-modal-btn" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x-circle" class="w-6 h-6"></i>
                </button>
            </div>
            <p id="confirm-modal-message" class="mb-6 text-gray-700"></p>
            <div class="flex justify-end pt-4 border-t mt-4">
                <button id="confirm-modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2 transition duration-200">
                    No
                </button>
                <button id="confirm-modal-yes-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center transition duration-200">
                    Yes
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide Icons after the DOM is loaded
        document.addEventListener('DOMContentLoaded', (event) => {
            lucide.createIcons();
            initApp(); // Call the main initialization function
        });

        // --- Data Storage (In-memory for this example) ---
        let students = [
            { id: 's1', name: 'Alice Smith', class: '10A' },
            { id: 's2', name: 'Bob Johnson', class: '10A' },
            { id: 's3', name: 'Charlie Brown', class: '10B' },
        ];

        const subjects = ['Mathematics', 'Science', 'History', 'English'];
        const markTypes = ['Quiz', 'Midterm', 'Final', 'Assignment'];
        const attendanceStatuses = ['Present', 'Absent', 'Late'];

        let marks = {
            's1': [
                { id: 'm1', subject: 'Mathematics', type: 'Quiz', score: 85, date: '2025-01-10' },
                { id: 'm2', subject: 'Mathematics', type: 'Midterm', score: 92, date: '2025-02-15' },
                { id: 'm3', subject: 'Mathematics', type: 'Assignment', score: 78, date: '2025-03-01' },
                { id: 'm4', subject: 'Mathematics', type: 'Quiz', score: 90, date: '2025-03-20' },
                { id: 'm5', subject: 'Science', type: 'Quiz', score: 70, date: '2025-01-12' },
                { id: 'm6', subject: 'Science', type: 'Midterm', score: 88, date: '2025-02-20' },
            ],
            's2': [
                { id: 'm7', subject: 'Mathematics', type: 'Quiz', score: 70, date: '2025-01-10' },
                { id: 'm8', subject: 'Mathematics', type: 'Midterm', score: 75, date: '2025-02-15' },
                { id: 'm9', subject: 'Mathematics', type: 'Assignment', score: 80, date: '2025-03-01' },
                { id: 'm10', subject: 'Science', type: 'Quiz', score: 65, date: '2025-01-12' },
            ],
            's3': [
                { id: 'm11', subject: 'History', type: 'Quiz', score: 95, date: '2025-01-15' },
                { id: 'm12', subject: 'History', type: 'Midterm', score: 88, date: '2025-02-28' },
                { id: 'm13', subject: 'English', type: 'Assignment', score: 70, date: '2025-03-05' },
            ],
        };

        let attendance = {
            's1': [
                { id: 'a1', subject: 'Mathematics', date: '2025-03-03', status: 'Present' },
                { id: 'a2', subject: 'Mathematics', date: '2025-03-04', status: 'Present' },
                { id: 'a3', subject: 'Science', date: '2025-03-03', status: 'Absent' },
                { id: 'a4', subject: 'Science', date: '2025-03-04', status: 'Present' },
            ],
            's2': [
                { id: 'a5', subject: 'Mathematics', date: '2025-03-03', status: 'Present' },
                { id: 'a6', subject: 'Mathematics', date: '2025-03-04', status: 'Late' },
                { id: 'a7', subject: 'Science', date: '2025-03-03', status: 'Present' },
            ],
            's3': [], // Charlie has no attendance initially
        };

        let feedback = {
            's1': [
                { id: 'f1', subject: 'Mathematics', teacher: 'Mr. David', text: 'Excellent problem-solving skills!', date: '2025-03-10' },
            ],
            's2': [
                { id: 'f2', subject: 'Science', teacher: 'Ms. Emily', text: 'Needs to participate more in class discussions.', date: '2025-03-15' },
            ],
            's3': [], // Charlie has no feedback initially
        };

        // --- Global State Variables ---
        let activeTab = 'students';
        let selectedStudentId = null;
        let selectedSubjectForGraphs = subjects[0]; // Default to first subject

        // --- Modal Variables ---
        let currentModalType = ''; // 'addStudent', 'editMark', 'addMark', 'editAttendance', 'addAttendance', 'addFeedback', 'editFeedback'
        let currentFormData = {};
        let editingItemId = null; // Stores ID of item being edited (mark, attendance, feedback)

        // --- Chart Instances ---
        let performanceChartInstance = null;
        let attendanceChartInstance = null;
        let marksDistributionChartInstance = null;

        // --- Utility Functions ---
        function generateId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        function getStudentName(id) {
            const student = students.find(s => s.id === id);
            return student ? student.name : 'Unknown Student';
        }

        function getCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Function to get the week number of a date
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            // Set to nearest Thursday: current date + 4 - current day number
            // Make Sunday 0, Monday 1, etc.
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            // Get first day of year
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            // Calculate full weeks to the nearest Thursday
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }

        // --- DOM Elements ---
        const navButtons = {
            students: document.getElementById('nav-students'),
            marks: document.getElementById('nav-marks'),
            attendance: document.getElementById('nav-attendance'),
            feedback: document.getElementById('nav-feedback'),
            graphs: document.getElementById('nav-graphs'),
        };

        const tabSections = {
            students: document.getElementById('tab-students'),
            marks: document.getElementById('tab-marks'),
            attendance: document.getElementById('tab-attendance'),
            feedback: document.getElementById('tab-feedback'),
            graphs: document.getElementById('tab-graphs'),
        };

        const selectedStudentInfo = document.getElementById('selected-student-info');
        const selectedStudentNameSpan = document.getElementById('selected-student-name');
        const clearStudentSelectionBtn = document.getElementById('clear-student-selection');
        const noStudentSelectedWarning = document.getElementById('no-student-selected-warning');

        const studentsTableBody = document.getElementById('students-table-body');
        const addStudentBtn = document.getElementById('add-student-btn');

        const marksTableBody = document.getElementById('marks-table-body');
        const addMarkBtn = document.getElementById('add-mark-btn');

        const attendanceTableBody = document.getElementById('attendance-table-body');
        const addAttendanceBtn = document.getElementById('add-attendance-btn');

        const feedbackTableBody = document.getElementById('feedback-table-body');
        const addFeedbackBtn = document.getElementById('add-feedback-btn');

        // Modal Elements
        const actionModal = document.getElementById('action-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalSaveBtn = document.getElementById('modal-save-btn');

        // Confirmation Modal Elements
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalMessage = document.getElementById('confirm-modal-message');
        const closeConfirmModalBtn = document.getElementById('close-confirm-modal-btn');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
        const confirmModalYesBtn = document.getElementById('confirm-modal-yes-btn');
        let confirmActionCallback = null; // Stores the function to call on 'Yes'

        // Graphs elements
        const subjectSelectForGraphs = document.getElementById('subjectSelect');
        const performanceChartCanvas = document.getElementById('performanceChart');
        const attendanceChartCanvas = document.getElementById('attendanceChart');
        const marksDistributionChartCanvas = document.getElementById('marksDistributionChart');
        const performanceChartTitle = document.getElementById('performance-chart-title');
        const attendanceChartTitle = document.getElementById('attendance-chart-title');
        const marksDistributionChartTitle = document.getElementById('marks-distribution-chart-title');
        const performanceChartNoData = document.getElementById('performance-chart-no-data');
        const attendanceChartNoData = document.getElementById('attendance-chart-no-data');
        const marksDistributionChartNoData = document.getElementById('marks-distribution-chart-no-data');


        // --- UI Rendering Functions ---
        function showTab(tabName) {
            // Hide all tabs
            Object.values(tabSections).forEach(section => section.classList.add('hidden'));
            // Deactivate all nav buttons
            Object.values(navButtons).forEach(button => button.classList.remove('bg-gray-700'));

            // Show selected tab
            tabSections[tabName].classList.remove('hidden');
            // Activate selected nav button
            navButtons[tabName].classList.add('bg-gray-700');

            activeTab = tabName;
            updateContentForActiveTab();
        }

        function updateContentForActiveTab() {
            // Update student selection display
            if (selectedStudentId) {
                selectedStudentInfo.classList.remove('hidden');
                noStudentSelectedWarning.classList.add('hidden');
                selectedStudentNameSpan.textContent = getStudentName(selectedStudentId);
            } else {
                selectedStudentInfo.classList.add('hidden');
                if (activeTab !== 'students') { // Only warn if not on the students tab
                    noStudentSelectedWarning.classList.remove('hidden');
                } else {
                    noStudentSelectedWarning.classList.add('hidden');
                }
            }

            // Render content based on active tab
            switch (activeTab) {
                case 'students':
                    renderStudentsTable();
                    break;
                case 'marks':
                    renderMarksTable();
                    break;
                case 'attendance':
                    renderAttendanceTable();
                    break;
                case 'feedback':
                    renderFeedbackTable();
                    break;
                case 'graphs':
                    populateSubjectSelectForGraphs();
                    renderCharts();
                    break;
            }

            // Enable/disable add buttons based on student selection
            const addButtons = [addMarkBtn, addAttendanceBtn, addFeedbackBtn];
            if (selectedStudentId) {
                addButtons.forEach(btn => btn.classList.remove('opacity-50', 'cursor-not-allowed'));
                addButtons.forEach(btn => btn.removeAttribute('disabled'));
            } else {
                addButtons.forEach(btn => btn.classList.add('opacity-50', 'cursor-not-allowed'));
                addButtons.forEach(btn => btn.setAttribute('disabled', 'true'));
            }
        }

        // --- Render Tables ---
        function renderStudentsTable() {
            studentsTableBody.innerHTML = '';
            students.forEach(student => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${student.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${student.class}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button data-id="${student.id}" class="select-student-btn text-indigo-600 hover:text-indigo-900 mr-3">
                            <i data-lucide="chevrons-right" class="w-5 h-5 inline-block"></i> Select
                        </button>
                        <button data-id="${student.id}" class="edit-student-btn text-blue-600 hover:text-blue-900 mr-3">
                            <i data-lucide="pencil" class="w-5 h-5 inline-block"></i> Edit
                        </button>
                        <button data-id="${student.id}" class="delete-student-btn text-red-600 hover:text-red-900">
                            <i data-lucide="trash-2" class="w-5 h-5 inline-block"></i> Delete
                        </button>
                    </td>
                `;
                studentsTableBody.appendChild(row);
            });
            lucide.createIcons(); // Re-render Lucide icons for new elements
            addStudentTableEventListeners();
        }

        function renderMarksTable() {
            marksTableBody.innerHTML = '';
            if (!selectedStudentId) {
                marksTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Please select a student to view marks.</td></tr>';
                return;
            }

            const studentMarks = marks[selectedStudentId] || [];
            if (studentMarks.length === 0) {
                marksTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No marks recorded for this student.</td></tr>';
                return;
            }

            studentMarks.forEach(mark => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${mark.subject}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${mark.type}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${mark.score}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${mark.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button data-id="${mark.id}" class="edit-mark-btn text-blue-600 hover:text-blue-900 mr-3">
                            <i data-lucide="pencil" class="w-5 h-5 inline-block"></i> Edit
                        </button>
                        <button data-id="${mark.id}" class="delete-mark-btn text-red-600 hover:text-red-900">
                            <i data-lucide="trash-2" class="w-5 h-5 inline-block"></i> Delete
                        </button>
                    </td>
                `;
                marksTableBody.appendChild(row);
            });
            lucide.createIcons();
            addMarksTableEventListeners();
        }

        function renderAttendanceTable() {
            attendanceTableBody.innerHTML = '';
            if (!selectedStudentId) {
                attendanceTableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Please select a student to view attendance.</td></tr>';
                return;
            }

            const studentAttendance = attendance[selectedStudentId] || [];
            if (studentAttendance.length === 0) {
                attendanceTableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No attendance recorded for this student.</td></tr>';
                return;
            }

            studentAttendance.forEach(att => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${att.subject}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${att.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${att.status}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button data-id="${att.id}" class="edit-attendance-btn text-blue-600 hover:text-blue-900 mr-3">
                            <i data-lucide="pencil" class="w-5 h-5 inline-block"></i> Edit
                        </button>
                        <button data-id="${att.id}" class="delete-attendance-btn text-red-600 hover:text-red-900">
                            <i data-lucide="trash-2" class="w-5 h-5 inline-block"></i> Delete
                        </button>
                    </td>
                `;
                attendanceTableBody.appendChild(row);
            });
            lucide.createIcons();
            addAttendanceTableEventListeners();
        }

        function renderFeedbackTable() {
            feedbackTableBody.innerHTML = '';
            if (!selectedStudentId) {
                feedbackTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Please select a student to view feedback.</td></tr>';
                return;
            }

            const studentFeedback = feedback[selectedStudentId] || [];
            if (studentFeedback.length === 0) {
                feedbackTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No feedback recorded for this student.</td></tr>';
                return;
            }

            studentFeedback.forEach(fb => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${fb.subject}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${fb.teacher}</td>
                    <td class="px-6 py-4 whitespace-pre-wrap text-sm text-gray-700">${fb.text}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${fb.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button data-id="${fb.id}" class="edit-feedback-btn text-blue-600 hover:text-blue-900 mr-3">
                            <i data-lucide="pencil" class="w-5 h-5 inline-block"></i> Edit
                        </button>
                        <button data-id="${fb.id}" class="delete-feedback-btn text-red-600 hover:text-red-900">
                            <i data-lucide="trash-2" class="w-5 h-5 inline-block"></i> Delete
                        </button>
                    </td>
                `;
                feedbackTableBody.appendChild(row);
            });
            lucide.createIcons();
            addFeedbackTableEventListeners();
        }

        // --- Event Listeners for Tables ---
        function addStudentTableEventListeners() {
            document.querySelectorAll('.select-student-btn').forEach(button => {
                button.onclick = (e) => {
                    selectedStudentId = e.currentTarget.dataset.id;
                    updateContentForActiveTab();
                };
            });
            document.querySelectorAll('.edit-student-btn').forEach(button => {
                button.onclick = (e) => {
                    const studentId = e.currentTarget.dataset.id;
                    const studentToEdit = students.find(s => s.id === studentId);
                    if (studentToEdit) {
                        openModal('editStudent', studentToEdit);
                    }
                };
            });
            document.querySelectorAll('.delete-student-btn').forEach(button => {
                button.onclick = (e) => {
                    const studentId = e.currentTarget.dataset.id;
                    const studentName = getStudentName(studentId);
                    showConfirmModal(`Are you sure you want to delete student "${studentName}" and all their associated data (marks, attendance, feedback)? This action cannot be undone.`, () => {
                        deleteStudent(studentId);
                    });
                };
            });
        }

        function addMarksTableEventListeners() {
            document.querySelectorAll('.edit-mark-btn').forEach(button => {
                button.onclick = (e) => {
                    const markId = e.currentTarget.dataset.id;
                    const markToEdit = marks[selectedStudentId].find(m => m.id === markId);
                    if (markToEdit) {
                        openModal('editMark', markToEdit);
                    }
                };
            });
            document.querySelectorAll('.delete-mark-btn').forEach(button => {
                button.onclick = (e) => {
                    const markId = e.currentTarget.dataset.id;
                    showConfirmModal('Are you sure you want to delete this mark?', () => {
                        deleteMark(markId);
                    });
                };
            });
        }

        function addAttendanceTableEventListeners() {
            document.querySelectorAll('.edit-attendance-btn').forEach(button => {
                button.onclick = (e) => {
                    const attendanceId = e.currentTarget.dataset.id;
                    const attendanceToEdit = attendance[selectedStudentId].find(a => a.id === attendanceId);
                    if (attendanceToEdit) {
                        openModal('editAttendance', attendanceToEdit);
                    }
                };
            });
            document.querySelectorAll('.delete-attendance-btn').forEach(button => {
                button.onclick = (e) => {
                    const attendanceId = e.currentTarget.dataset.id;
                    showConfirmModal('Are you sure you want to delete this attendance record?', () => {
                        deleteAttendance(attendanceId);
                    });
                };
            });
        }

        function addFeedbackTableEventListeners() {
            document.querySelectorAll('.edit-feedback-btn').forEach(button => {
                button.onclick = (e) => {
                    const feedbackId = e.currentTarget.dataset.id;
                    const feedbackToEdit = feedback[selectedStudentId].find(f => f.id === feedbackId);
                    if (feedbackToEdit) {
                        openModal('editFeedback', feedbackToEdit);
                    }
                };
            });
            document.querySelectorAll('.delete-feedback-btn').forEach(button => {
                button.onclick = (e) => {
                    const feedbackId = e.currentTarget.dataset.id;
                    showConfirmModal('Are you sure you want to delete this feedback?', () => {
                        deleteFeedback(feedbackId);
                    });
                };
            });
        }

        // --- Modal Handling ---
        function openModal(type, data = {}) {
            currentModalType = type;
            editingItemId = data.id || null;
            currentFormData = { ...data }; // Copy data to form state

            modalBody.innerHTML = ''; // Clear previous form fields

            switch (type) {
                case 'addStudent':
                case 'editStudent':
                    modalTitle.textContent = type === 'addStudent' ? 'Add New Student' : `Edit Student: ${data.name || ''}`;
                    modalBody.innerHTML = `
                        <div>
                            <label for="studentName" class="block text-sm font-medium text-gray-700">Name</label>
                            <input type="text" id="studentName" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" value="${data.name || ''}" required>
                        </div>
                        <div>
                            <label for="studentClass" class="block text-sm font-medium text-gray-700">Class</label>
                            <input type="text" id="studentClass" name="class" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" value="${data.class || ''}" required>
                        </div>
                    `;
                    break;
                case 'addMark':
                case 'editMark':
                    modalTitle.textContent = type === 'addMark' ? 'Add New Mark' : `Edit Mark for ${getStudentName(selectedStudentId)}`;
                    modalBody.innerHTML = `
                        <div>
                            <label for="markSubject" class="block text-sm font-medium text-gray-700">Subject</label>
                            <select id="markSubject" name="subject" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required>
                                ${subjects.map(sub => `<option value="${sub}" ${data.subject === sub ? 'selected' : ''}>${sub}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="markType" class="block text-sm font-medium text-gray-700">Type</label>
                            <select id="markType" name="type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required>
                                ${markTypes.map(mt => `<option value="${mt}" ${data.type === mt ? 'selected' : ''}>${mt}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="markScore" class="block text-sm font-medium text-gray-700">Score</label>
                            <input type="number" id="markScore" name="score" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" value="${data.score || ''}" min="0" max="100" required>
                        </div>
                        <div>
                            <label for="markDate" class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="markDate" name="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" value="${data.date || getCurrentDate()}" required>
                        </div>
                    `;
                    break;
                case 'addAttendance':
                case 'editAttendance':
                    modalTitle.textContent = type === 'addAttendance' ? 'Mark Attendance' : `Edit Attendance for ${getStudentName(selectedStudentId)}`;
                    modalBody.innerHTML = `
                        <div>
                            <label for="attendanceSubject" class="block text-sm font-medium text-gray-700">Subject</label>
                            <select id="attendanceSubject" name="subject" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required>
                                ${subjects.map(sub => `<option value="${sub}" ${data.subject === sub ? 'selected' : ''}>${sub}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="attendanceDate" class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="attendanceDate" name="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" value="${data.date || getCurrentDate()}" required>
                        </div>
                        <div>
                            <label for="attendanceStatus" class="block text-sm font-medium text-gray-700">Status</label>
                            <select id="attendanceStatus" name="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required>
                                ${attendanceStatuses.map(status => `<option value="${status}" ${data.status === status ? 'selected' : ''}>${status}</option>`).join('')}
                            </select>
                        </div>
                    `;
                    break;
                case 'addFeedback':
                case 'editFeedback':
                    modalTitle.textContent = type === 'addFeedback' ? 'Give New Feedback' : `Edit Feedback for ${getStudentName(selectedStudentId)}`;
                    modalBody.innerHTML = `
                        <div>
                            <label for="feedbackSubject" class="block text-sm font-medium text-gray-700">Subject</label>
                            <select id="feedbackSubject" name="subject" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required>
                                ${subjects.map(sub => `<option value="${sub}" ${data.subject === sub ? 'selected' : ''}>${sub}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="feedbackTeacher" class="block text-sm font-medium text-gray-700">Teacher</label>
                            <input type="text" id="feedbackTeacher" name="teacher" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" value="${data.teacher || ''}" required>
                        </div>
                        <div>
                            <label for="feedbackText" class="block text-sm font-medium text-gray-700">Feedback</label>
                            <textarea id="feedbackText" name="text" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required>${data.text || ''}</textarea>
                        </div>
                        <div>
                            <label for="feedbackDate" class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="feedbackDate" name="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" value="${data.date || getCurrentDate()}" required>
                        </div>
                    `;
                    break;
            }
            actionModal.classList.remove('hidden');
            lucide.createIcons(); // Re-render Lucide icons if any were added within the modal
        }

        function closeModal() {
            actionModal.classList.add('hidden');
            currentModalType = '';
            editingItemId = null;
            currentFormData = {};
        }

        function showConfirmModal(message, callback) {
            confirmModalMessage.textContent = message;
            confirmActionCallback = callback;
            confirmModal.classList.remove('hidden');
        }

        function closeConfirmModal() {
            confirmModal.classList.add('hidden');
            confirmActionCallback = null;
        }

        // --- Data Manipulation Functions ---

        // Students
        function addStudent(studentData) {
            const newStudent = { id: generateId(), ...studentData };
            students.push(newStudent);
            marks[newStudent.id] = [];
            attendance[newStudent.id] = [];
            feedback[newStudent.id] = [];
            renderStudentsTable();
            closeModal();
            selectedStudentId = newStudent.id; // Automatically select the new student
            updateContentForActiveTab();
        }

        function editStudent(studentId, updatedData) {
            const index = students.findIndex(s => s.id === studentId);
            if (index !== -1) {
                students[index] = { ...students[index], ...updatedData };
                renderStudentsTable();
                closeModal();
                updateContentForActiveTab(); // Update header if selected student was edited
            }
        }

        function deleteStudent(studentId) {
            students = students.filter(s => s.id !== studentId);
            delete marks[studentId];
            delete attendance[studentId];
            delete feedback[studentId];

            if (selectedStudentId === studentId) {
                selectedStudentId = null;
            }
            renderStudentsTable();
            updateContentForActiveTab();
            closeConfirmModal();
        }

        // Marks
        function addMark(markData) {
            if (!selectedStudentId) return;
            const newMark = { id: generateId(), ...markData };
            if (!marks[selectedStudentId]) {
                marks[selectedStudentId] = [];
            }
            marks[selectedStudentId].push(newMark);
            renderMarksTable();
            closeModal();
            if (activeTab === 'graphs') renderCharts();
        }

        function editMark(markId, updatedData) {
            if (!selectedStudentId) return;
            const studentMarks = marks[selectedStudentId];
            const index = studentMarks.findIndex(m => m.id === markId);
            if (index !== -1) {
                studentMarks[index] = { ...studentMarks[index], ...updatedData };
                renderMarksTable();
                closeModal();
                if (activeTab === 'graphs') renderCharts();
            }
        }

        function deleteMark(markId) {
            if (!selectedStudentId) return;
            marks[selectedStudentId] = marks[selectedStudentId].filter(m => m.id !== markId);
            renderMarksTable();
            closeConfirmModal();
            if (activeTab === 'graphs') renderCharts();
        }

        // Attendance
        function addAttendance(attendanceData) {
            if (!selectedStudentId) return;
            const newAttendance = { id: generateId(), ...attendanceData };
            if (!attendance[selectedStudentId]) {
                attendance[selectedStudentId] = [];
            }
            attendance[selectedStudentId].push(newAttendance);
            renderAttendanceTable();
            closeModal();
            if (activeTab === 'graphs') renderCharts();
        }

        function editAttendance(attendanceId, updatedData) {
            if (!selectedStudentId) return;
            const studentAttendance = attendance[selectedStudentId];
            const index = studentAttendance.findIndex(a => a.id === attendanceId);
            if (index !== -1) {
                studentAttendance[index] = { ...studentAttendance[index], ...updatedData };
                renderAttendanceTable();
                closeModal();
                if (activeTab === 'graphs') renderCharts();
            }
        }

        function deleteAttendance(attendanceId) {
            if (!selectedStudentId) return;
            attendance[selectedStudentId] = attendance[selectedStudentId].filter(a => a.id !== attendanceId);
            renderAttendanceTable();
            closeConfirmModal();
            if (activeTab === 'graphs') renderCharts();
        }

        // Feedback
        function addFeedback(feedbackData) {
            if (!selectedStudentId) return;
            const newFeedback = { id: generateId(), ...feedbackData };
            if (!feedback[selectedStudentId]) {
                feedback[selectedStudentId] = [];
            }
            feedback[selectedStudentId].push(newFeedback);
            renderFeedbackTable();
            closeModal();
        }

        function editFeedback(feedbackId, updatedData) {
            if (!selectedStudentId) return;
            const studentFeedback = feedback[selectedStudentId];
            const index = studentFeedback.findIndex(f => f.id === feedbackId);
            if (index !== -1) {
                studentFeedback[index] = { ...studentFeedback[index], ...updatedData };
                renderFeedbackTable();
                closeModal();
            }
        }

        function deleteFeedback(feedbackId) {
            if (!selectedStudentId) return;
            feedback[selectedStudentId] = feedback[selectedStudentId].filter(f => f.id !== feedbackId);
            renderFeedbackTable();
            closeConfirmModal();
        }


        // --- Graphing Logic (Chart.js) ---
        function populateSubjectSelectForGraphs() {
            subjectSelectForGraphs.innerHTML = subjects.map(sub =>
                `<option value="${sub}" ${selectedSubjectForGraphs === sub ? 'selected' : ''}>${sub}</option>`
            ).join('');
        }

        function preparePerformanceData() {
            if (!selectedStudentId || !selectedSubjectForGraphs) return { labels: [], datasets: [] };

            const studentMarks = marks[selectedStudentId] || [];
            const filteredMarks = studentMarks
                .filter(m => m.subject === selectedSubjectForGraphs)
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            const weeklyScores = {};
            filteredMarks.forEach(mark => {
                const date = new Date(mark.date);
                const year = date.getFullYear();
                const week = getWeekNumber(date); // Use custom week number calculation

                const weekKey = `${year}-W${String(week).padStart(2, '0')}`;
                if (!weeklyScores[weekKey]) {
                    weeklyScores[weekKey] = { totalScore: 0, count: 0 };
                }
                weeklyScores[weekKey].totalScore += mark.score;
                weeklyScores[weekKey].count += 1;
            });

            const sortedWeeks = Object.keys(weeklyScores).sort();
            const labels = sortedWeeks;
            const data = sortedWeeks.map(weekKey => (weeklyScores[weekKey].totalScore / weeklyScores[weekKey].count).toFixed(2));

            return {
                labels: labels,
                datasets: [{
                    label: 'Average Score',
                    data: data,
                    borderColor: '#8884d8',
                    tension: 0.1,
                    fill: false
                }]
            };
        }

        function prepareAttendanceData() {
            if (!selectedStudentId) return { labels: [], datasets: [] };
            const studentAttendance = attendance[selectedStudentId] || [];
            const summary = studentAttendance.reduce((acc, curr) => {
                acc[curr.status] = (acc[curr.status] || 0) + 1;
                return acc;
            }, {});

            const labels = Object.keys(summary);
            const data = Object.values(summary);
            const colors = ['#0088FE', '#FFBB28', '#FF8042', '#00C49F']; // Present, Absent, Late, Other

            return {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: labels.map((_, i) => colors[i % colors.length]),
                    hoverOffset: 4
                }]
            };
        }

        function prepareMarksDistributionData() {
            if (!selectedStudentId) return { labels: [], datasets: [] };
            const studentMarks = marks[selectedStudentId] || [];
            const distribution = studentMarks.reduce((acc, curr) => {
                const subject = curr.subject;
                if (!acc[subject]) {
                    acc[subject] = { totalScore: 0, count: 0 };
                }
                acc[subject].totalScore += curr.score;
                acc[subject].count += 1;
                return acc;
            }, {});

            const labels = Object.keys(distribution);
            const data = labels.map(subject => (distribution[subject].totalScore / distribution[subject].count).toFixed(2));

            return {
                labels: labels,
                datasets: [{
                    label: 'Average Score',
                    data: data,
                    backgroundColor: '#82ca9d',
                }]
            };
        }

        function renderCharts() {
            // Destroy existing chart instances to prevent duplicates
            if (performanceChartInstance) performanceChartInstance.destroy();
            if (attendanceChartInstance) attendanceChartInstance.destroy();
            if (marksDistributionChartInstance) marksDistributionChartInstance.destroy();

            if (!selectedStudentId) {
                // Hide chart canvases and show "no data" messages if no student selected
                performanceChartCanvas.classList.add('hidden');
                attendanceChartCanvas.classList.add('hidden');
                marksDistributionChartCanvas.classList.add('hidden');
                performanceChartNoData.classList.remove('hidden');
                attendanceChartNoData.classList.remove('hidden');
                marksDistributionChartNoData.classList.remove('hidden');
                return;
            } else {
                performanceChartCanvas.classList.remove('hidden');
                attendanceChartCanvas.classList.remove('hidden');
                marksDistributionChartCanvas.classList.remove('hidden');
                performanceChartNoData.classList.add('hidden');
                attendanceChartNoData.classList.add('hidden');
                marksDistributionChartNoData.classList.add('hidden');
            }

            // Performance Chart
            const performanceData = preparePerformanceData();
            performanceChartTitle.textContent = `${getStudentName(selectedStudentId)}'s Performance in ${selectedSubjectForGraphs} (Weekly Average)`;
            if (performanceData.labels.length > 0) {
                performanceChartNoData.classList.add('hidden');
                performanceChartCanvas.classList.remove('hidden');
                performanceChartInstance = new Chart(performanceChartCanvas, {
                    type: 'line',
                    data: performanceData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, max: 100 }
                        },
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: { mode: 'index', intersect: false }
                        }
                    }
                });
            } else {
                performanceChartNoData.classList.remove('hidden');
                performanceChartCanvas.classList.add('hidden');
            }

            // Attendance Chart
            const attendanceData = prepareAttendanceData();
            attendanceChartTitle.textContent = `${getStudentName(selectedStudentId)}'s Attendance Summary`;
            if (attendanceData.labels.length > 0) {
                attendanceChartNoData.classList.add('hidden');
                attendanceChartCanvas.classList.remove('hidden');
                attendanceChartInstance = new Chart(attendanceChartCanvas, {
                    type: 'pie',
                    data: attendanceData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += context.parsed;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                attendanceChartNoData.classList.remove('hidden');
                attendanceChartCanvas.classList.add('hidden');
            }

            // Marks Distribution Chart
            const marksDistributionData = prepareMarksDistributionData();
            marksDistributionChartTitle.textContent = `${getStudentName(selectedStudentId)}'s Average Marks by Subject`;
            if (marksDistributionData.labels.length > 0) {
                marksDistributionChartNoData.classList.add('hidden');
                marksDistributionChartCanvas.classList.remove('hidden');
                marksDistributionChartInstance = new Chart(marksDistributionChartCanvas, {
                    type: 'bar',
                    data: marksDistributionData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, max: 100 }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            } else {
                marksDistributionChartNoData.classList.remove('hidden');
                marksDistributionChartCanvas.classList.add('hidden');
            }
        }


        // --- Event Listeners Initialization ---
        function initApp() {
            // Navigation
            Object.keys(navButtons).forEach(tab => {
                navButtons[tab].addEventListener('click', () => showTab(tab));
            });

            // Student selection clear
            clearStudentSelectionBtn.addEventListener('click', () => {
                selectedStudentId = null;
                updateContentForActiveTab();
            });

            // Add Buttons
            addStudentBtn.addEventListener('click', () => openModal('addStudent'));
            addMarkBtn.addEventListener('click', () => {
                if (selectedStudentId) openModal('addMark');
                else alert('Please select a student first!');
            });
            addAttendanceBtn.addEventListener('click', () => {
                if (selectedStudentId) openModal('addAttendance');
                else alert('Please select a student first!');
            });
            addFeedbackBtn.addEventListener('click', () => {
                if (selectedStudentId) openModal('addFeedback');
                else alert('Please select a student first!');
            });

            // Modal Action Buttons
            closeModalBtn.addEventListener('click', closeModal);
            modalCancelBtn.addEventListener('click', closeModal);
            modalSaveBtn.addEventListener('click', () => {
                const formElements = modalBody.querySelectorAll('input, select, textarea');
                let formData = {};
                let isValid = true;

                formElements.forEach(element => {
                    formData[element.name] = element.value;
                    if (element.hasAttribute('required') && !element.value) {
                        isValid = false;
                    }
                    if (element.type === 'number') {
                        formData[element.name] = parseFloat(element.value);
                        if (element.name === 'score' && (formData[element.name] < 0 || formData[element.name] > 100)) {
                            isValid = false;
                        }
                    }
                });

                if (!isValid) {
                    alert('Please fill in all required fields correctly.');
                    return;
                }

                switch (currentModalType) {
                    case 'addStudent':
                        addStudent(formData);
                        break;
                    case 'editStudent':
                        editStudent(editingItemId, formData);
                        break;
                    case 'addMark':
                        addMark(formData);
                        break;
                    case 'editMark':
                        editMark(editingItemId, formData);
                        break;
                    case 'addAttendance':
                        addAttendance(formData);
                        break;
                    case 'editAttendance':
                        editAttendance(editingItemId, formData);
                        break;
                    case 'addFeedback':
                        addFeedback(formData);
                        break;
                    case 'editFeedback':
                        editFeedback(editingItemId, formData);
                        break;
                }
            });

            // Confirmation Modal Buttons
            closeConfirmModalBtn.addEventListener('click', closeConfirmModal);
            confirmModalCancelBtn.addEventListener('click', closeConfirmModal);
            confirmModalYesBtn.addEventListener('click', () => {
                if (confirmActionCallback) {
                    confirmActionCallback();
                }
            });

            // Graphs Subject Select Change
            subjectSelectForGraphs.addEventListener('change', (e) => {
                selectedSubjectForGraphs = e.target.value;
                renderCharts();
            });

            // Initial render
            showTab('students');
        }
    </script>
</body>
</html>